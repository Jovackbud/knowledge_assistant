<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4AI Knowledge Assistant</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #212529;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --message-user-bg: #e9f5ff;
            --message-assistant-bg: #f1f3f5;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            font-family: var(--font-family); margin: 0; padding: 20px;
            background-color: var(--bg-color); color: var(--text-color);
        }
        .container {
            max-width: 800px; margin: 0 auto; background-color: var(--container-bg);
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px;
        }
        h1, h2, h3, legend { color: #343a40; }
        h1 { text-align: center; margin-bottom: 2rem; }
        .hidden { display: none !important; }
        section, .section {
            margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px;
        }
        #chat-history {
            height: 450px; border: 1px solid var(--border-color); overflow-y: auto;
            padding: 1rem; margin-bottom: 1rem; background-color: var(--bg-color);
            border-radius: 5px; display: flex; flex-direction: column; gap: 1rem;
        }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.6; max-width: 85%; word-wrap: break-word; }
        .user-message { background-color: var(--message-user-bg); align-self: flex-end; text-align: left; }
        .assistant-message { background-color: var(--message-assistant-bg); align-self: flex-start; }
        .assistant-message-content p:first-child { margin-top: 0; }
        .assistant-message-content p:last-child { margin-bottom: 0; }
        .assistant-message-content ul, .assistant-message-content ol { padding-left: 20px; }
        .sources-container { font-size: 0.85em; color: #555; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color); }
        .sources-container strong { color: var(--text-color); }
        .sources-container ul { list-style-type: none; padding-left: 0; margin-top: 0.5rem; }
        .source-item { font-family: monospace; background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; display: inline-block; margin: 2px; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #495057; }
        input, textarea, select {
            width: calc(100% - 24px); padding: 10px; margin-bottom: 1rem; border: 1px solid var(--border-color);
            border-radius: 4px; font-size: 1em; background-color: var(--input-bg); color: var(--text-color);
        }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; margin-bottom: 0; }
        button {
            padding: 10px 15px; background-color: var(--primary-color); color: white;
            border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background-color 0.2s;
        }
        button:hover { background-color: var(--primary-hover); }
        button:disabled { background-color: #a0c7ff; cursor: not-allowed; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }
        #openAdminPanelButton { background-color: #ffc107; color: #212529; }
        #openAdminPanelButton:hover { background-color: #e0a800; }
        .error-message { color: var(--danger-color); font-weight: bold; }
        .success-message { color: #198754; font-weight: bold; }
        #ticket-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--container-bg); padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            z-index: 1000; border-radius: 8px; border-top: 5px solid var(--primary-color);
            width: 90%; max-width: 500px;
        }
        fieldset { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        legend { font-weight: 700; font-size: 1.1em; padding: 0 10px; color: #333; }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #e9ecef; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        small { color: #6c757d; font-style: italic; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1001;
        }
        .admin-modal-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 900px; height: 80vh; max-height: 700px;
            background-color: var(--container-bg); border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; z-index: 1002;
        }
        .admin-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .admin-modal-header h2 { margin: 0; }
        .admin-modal-close-btn { font-size: 1.5rem; font-weight: bold; border: none; background: none; cursor: pointer; color: var(--secondary-color); }
        .admin-modal-body { display: flex; flex-grow: 1; overflow: hidden; }
        .admin-modal-nav {
            flex: 0 0 200px; padding: 1rem; border-right: 1px solid var(--border-color);
            background-color: var(--bg-color);
        }
        .admin-nav-button {
            display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border: none; background-color: transparent; color: var(--text-color); font-size: 1rem; border-radius: 4px;
        }
        .admin-nav-button.active, .admin-nav-button:hover { background-color: var(--primary-color); color: white; }
        .admin-modal-content { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }
        .tickets-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .tickets-table th, .tickets-table td {
            border: 1px solid var(--border-color); padding: 8px 12px; text-align: left;
        }
        .tickets-table thead { background-color: var(--bg-color); }
        .tickets-table td.ticket-question { max-width: 300px; white-space: pre-wrap; word-break: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI4AI Knowledge Assistant</h1>
        <section id="login-section"><h2>Login</h2><label for="email">Work Email:</label><input type="email" id="email" placeholder="user@example.com"><button id="loginButton">Login</button><p id="login-error" class="error-message"></p></section>
        <section id="user-profile-section" class="hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><div><h2>User Profile</h2><p><strong>Email:</strong> <span id="profile-email"></span></p></div><button id="logoutButton" class="btn-secondary">Logout</button></div><div id="admin-controls-area" class="hidden" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);"><button id="openAdminPanelButton">Admin Panel</button></div></section>
        <section id="chat-section" class="hidden"><h2>Chat</h2><div id="chat-history"></div><div id="chat-input-area"><textarea id="chat-input" placeholder="Ask your question..." rows="1"></textarea><button id="sendChatButton">Send</button></div></section>
        <section id="feedback-section" class="hidden" style="text-align: center;"><h3>Was this answer helpful?</h3><div id="feedback-buttons"><button id="helpfulButton">üëç Helpful</button><button id="notHelpfulButton">üëé Not Helpful</button></div><p id="feedback-message" class="success-message"></p></section>
        <div id="ticket-creation-trigger" class="hidden" style="text-align: center;"><hr style="margin-top: 2rem; margin-bottom: 1rem;"><button id="openTicketModalButton">Create Support Ticket</button></div>
        <div id="ticket-modal" class="hidden"><h2>New Support Ticket</h2><label for="ticket-question">Your Question/Issue:</label><textarea id="ticket-question" rows="4"></textarea><label for="ticket-team">Select a Team:</label><select id="ticket-team"></select><p id="team-suggestion" style="font-style: italic; color: #555; margin-top: -0.5rem; margin-bottom: 1rem;"></p><button id="submitTicketButton">Submit Ticket</button><button type="button" id="cancelTicketButton" class="btn-secondary">Cancel</button><p id="ticket-submission-message" style="margin-top: 1rem;"></p></div>
    </div>

    <div id="admin-modal-overlay" class="modal-overlay hidden"></div>
    <div id="admin-modal" class="admin-modal-container hidden">
        <div class="admin-modal-header"><h2>Admin Panel</h2><button id="admin-modal-close-btn" class="admin-modal-close-btn">√ó</button></div>
        <div class="admin-modal-body">
            <nav class="admin-modal-nav">
                <button class="admin-nav-button active" data-panel="view-tickets-panel">View Tickets</button>
                <button class="admin-nav-button" data-panel="view-permissions-panel">View Permissions</button>
                <button class="admin-nav-button" data-panel="manage-permissions-panel">Manage Permissions</button>
                <button class="admin-nav-button" data-panel="remove-user-panel">Remove User</button>
            </nav>
            <main class="admin-modal-content">
                <div id="view-tickets-panel" class="admin-panel active">
                    <fieldset><legend>Recent Support Tickets</legend>
                        <p id="tickets-loading-message">Loading tickets...</p>
                        <div id="tickets-table-container" class="hidden">
                            <table class="tickets-table">
                                <thead><tr><th>Timestamp</th><th>User</th><th>Question</th><th>Selected Team</th><th>Status</th></tr></thead>
                                <tbody id="tickets-table-body"></tbody>
                            </table>
                        </div>
                    </fieldset>
                </div>
                <div id="view-permissions-panel" class="admin-panel"><fieldset><legend>View User Permissions</legend><label for="view-target-user-email">User Email to View:</label><input type="email" id="view-target-user-email"><button type="button" id="viewPermissionsButton">View Permissions</button><div id="admin-view-permissions-message" style="margin-top: 10px;"></div><div id="user-permissions-display" class="hidden" style="margin-top: 10px;"><h4>Permissions for <span id="display-user-email"></span>:</h4><pre id="display-user-permissions-json"></pre></div></fieldset></div>
                <div id="manage-permissions-panel" class="admin-panel"><fieldset><legend>Manage User Permissions</legend><form id="admin-permissions-form"><label for="target-user-email">Target User Email:</label><input type="email" id="target-user-email" required><small style="display: block; margin-top: -0.5rem; margin-bottom: 1rem;">(Creates a new user or updates an existing one.)</small><label for="target-hierarchy-level">New Hierarchy Level:</label><input type="number" id="target-hierarchy-level" placeholder="e.g., 0, 1, 2, 3 (blank for no change)"><label for="target-departments">Departments (comma-separated):</label><input type="text" id="target-departments" list="known-departments-list" placeholder="e.g., HR,IT (blank for no change)"><datalist id="known-departments-list"></datalist><label for="target-projects">Projects (comma-separated):</label><input type="text" id="target-projects" placeholder="e.g., ProjectAlpha (blank for no change)"><label>Contextual Roles:</label><div style="display: flex; gap: 10px; align-items: center; margin-bottom: 0.5rem;"><input type="text" id="role-context-tag" placeholder="Context (e.g., PROJECT_ALPHA)" style="margin-bottom: 0;"><input type="text" id="role-name-tag" placeholder="Role Name (e.g., LEAD)" style="margin-bottom: 0;"><button type="button" id="addRoleButton" style="flex-shrink: 0;">Add Role</button></div><label>Current Roles to Add/Update:</label><pre id="contextual-roles-preview">{}</pre><small>(Building roles here will overwrite all existing contextual roles for this user upon submission.)</small><button type="submit" style="margin-top: 1rem;">Update User Permissions</button></form><div id="admin-permissions-message" style="margin-top: 10px;"></div></fieldset></div>
                <div id="remove-user-panel" class="admin-panel"><fieldset><legend>Remove User</legend><label for="remove-target-user-email">User Email to Remove:</label><input type="email" id="remove-target-user-email"><button type="button" id="removeUserButton" class="btn-danger">Remove User</button><div id="admin-remove-user-message" style="margin-top: 10px;"></div></fieldset></div>
            </main>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>